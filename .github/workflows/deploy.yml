# # name: Build and Deploy to ECS

# # on:
# #   push:
# #     branches:
# #       - main

# # env:
# #   AWS_REGION: ap-south-1
# #   ECR_REPOSITORY: strapi-app-repo
# #   ECS_SERVICE: strapi-service
# #   ECS_CLUSTER: strapi-cluster
# #   TASK_FAMILY: strapi-task

# # jobs:
# #   deploy:
# #     runs-on: ubuntu-latest

# #     steps:
# #       - name: Checkout
# #         uses: actions/checkout@v3

# #       - name: Configure AWS
# #         uses: aws-actions/configure-aws-credentials@v2
# #         with:
# #           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
# #           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
# #           aws-region: ${{ env.AWS_REGION }}

# #       - name: Login to ECR
# #         id: login-ecr
# #         uses: aws-actions/amazon-ecr-login@v1

# #       - name: Build, tag, push image
# #         id: build-image
# #         run: |
# #           IMAGE_TAG=${{ github.sha }}
# #           docker build -t $ECR_REPOSITORY:$IMAGE_TAG .

# #           docker tag $ECR_REPOSITORY:$IMAGE_TAG ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG
# #           docker push ${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG
# #           echo "image=${{ steps.login-ecr.outputs.registry }}/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

# #       - name: Update ECS task definition
# #         run: |
# #           aws ecs register-task-definition \
# #             --family $TASK_FAMILY \
# #             --network-mode awsvpc \
# #             --requires-compatibilities FARGATE \
# #             --cpu 256 \
# #             --memory 512 \
# #             --execution-role-arn arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/ecsTaskExecutionRole \
# #             --container-definitions "[{
# #               \"name\": \"strapi\",
# #               \"image\": \"${{ steps.build-image.outputs.image }}\",
# #               \"essential\": true,
# #               \"portMappings\": [{
# #                 \"containerPort\": 1337,
# #                 \"hostPort\": 1337
# #               }]
# #             }]"

# #       - name: Deploy new revision
# #         run: |
# #           aws ecs update-service \
# #             --cluster $ECS_CLUSTER \
# #             --service $ECS_SERVICE \
# #             --force-new-deployment


# name: Build and Deploy to ECS

# on:
#   push:
#     branches:
#       - main

# env:
#   AWS_REGION: ap-south-1
#   ECR_REPOSITORY: strapi-app-repo
#   ECS_SERVICE: strapi-service
#   ECS_CLUSTER: strapi-cluster
#   TASK_FAMILY: strapi-task

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v3

#       - name: Configure AWS credentials
#         uses: aws-actions/configure-aws-credentials@v2
#         with:
#           aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#           aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#           aws-region: ${{ env.AWS_REGION }}

#       - name: Login to Amazon ECR
#         id: login-ecr
#         uses: aws-actions/amazon-ecr-login@v1

#       - name: Build, tag and push image to ECR
#         id: build-image
#         run: |
#           IMAGE_TAG=${{ github.sha }}
#           IMAGE_URI=${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG

#           docker build -t $IMAGE_URI .
#           docker push $IMAGE_URI

#           echo "image=$IMAGE_URI" >> $GITHUB_OUTPUT

#       # ðŸ”¥ Get existing task definition
#       - name: Download current task definition
#         run: |
#           aws ecs describe-task-definition \
#             --task-definition $TASK_FAMILY \
#             --query taskDefinition > task-definition.json

#       # ðŸ”¥ Update only the image
#       - name: Create new task definition revision
#         run: |
#           cat task-definition.json | \
#           jq --arg IMAGE "${{ steps.build-image.outputs.image }}" \
#           '.containerDefinitions[0].image=$IMAGE
#           | del(.taskDefinitionArn)
#           | del(.revision)
#           | del(.status)
#           | del(.requiresAttributes)
#           | del(.compatibilities)
#           | del(.registeredAt)
#           | del(.registeredBy)' \
#           > new-task-definition.json

#           aws ecs register-task-definition \
#             --cli-input-json file://new-task-definition.json

#       # ðŸš€ Deploy new revision
#       - name: Deploy to ECS
#         run: |
#           aws ecs update-service \
#             --cluster $ECS_CLUSTER \
#             --service $ECS_SERVICE \
#             --force-new-deployment

